{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "Create a new ACME client for certificate management",
        "resourceGroup": {
          "constraints": {
            "validations": [
              {
                "permission": "Microsoft.KeyVault/vaults/write",
                "message": "You must have permission to create and update Key Vaults"
              },
              {
                "permission": "Microsoft.Web/sites/write",
                "message": "You must have permission to create and update Azure Functions"
              },
              {
                "permission": "Microsoft.Web/serverFarms/write",
                "message": "You must have permission to create and update App Service Plans"
              },
              {
                "permission": "Microsoft.Storage/storageAccounts/write",
                "message": "You must have permission to create and update Storage Accounts"
              }
            ]
          }
        },
        "location": {
          "label": "Location",
          "toolTip": "Location for all resources",
          "resourceTypes": [
            "Microsoft.KeyVault",
            "Microsoft.Web",
            "Microsoft.Storage",
            "Microsoft.Insights",
            "Microsoft.OperationalInsights"
          ]
        }
      }
    },
    "basics": [
      {
        "name": "namingRule",
        "type": "Microsoft.Common.OptionsGroup",
        "label": "Naming rule",
        "toolTip": "",
        "constraints": {
          "allowedValues": [
            {
              "label": "Prefixed (recommended)",
              "value": "prefixed"
            },
            {
              "label": "Custom",
              "value": "custom"
            }
          ],
          "required": true
        },
        "visible": true
      },
      {
        "name": "appPrefix",
        "type": "Microsoft.Common.TextBox",
        "label": "App prefix name",
        "placeholder": "App prefix name",
        "defaultValue": "",
        "toolTip": "Use alphanumeric characters or hyphens with minimum of 2 characters and maximum of 47 characters.",
        "constraints": {
          "required": true
        },
        "visible": "[if(equals(basics('namingRule'), 'prefixed'), true, false)]"
      }
    ],
    "steps": [
      {
        "name": "acmeStep",
        "label": "ACME settings",
        "subLabel": {
          "preValidation": "Configure the ACME settings",
          "postValidation": "Completed"
        },
        "elements": [
          {
            "name": "endpointSection",
            "type": "Microsoft.Common.Section",
            "label": "ACME endpoint",
            "elements": [
              {
                "name": "endpointType",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Endpoint type",
                "toolTip": "",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Known endpoint (recommended)",
                      "value": "known"
                    },
                    {
                      "label": "Custom",
                      "value": "custom"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "knownEndpoint",
                "type": "Microsoft.Common.DropDown",
                "label": "Known ACME endpoint",
                "placeholder": "ACME endpoint",
                "defaultValue": "",
                "multiLine": true,
                "toolTip": "Use alphanumeric characters or hyphens with minimum of 2 characters and maximum of 47 characters.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Let's Encrypt",
                      "description": "The value to select for option 1.",
                      "value": "https://acme-v02.api.letsencrypt.org/directory"
                    },
                    {
                      "label": "Buypass Go SSL",
                      "description": "The value to select for option 2.",
                      "value": "https://api.buypass.com/acme/directory"
                    },
                    {
                      "label": "ZeroSSL",
                      "description": "The value to select for option 3.",
                      "value": "https://acme.zerossl.com/v2/DV90"
                    },
                    {
                      "label": "Google Trust Services",
                      "description": "The value to select for option 4.",
                      "value": "https://dv.acme-v02.api.pki.goog/directory"
                    },
                    {
                      "label": "SSL.com",
                      "description": "The value to select for option 4.",
                      "value": "https://acme.ssl.com/sslcom-dv-ecc"
                    },
                    {
                      "label": "Entrust",
                      "description": "The value to select for option 4.",
                      "value": "https://acme.entrust.net/acme2/directory"
                    },
                    {
                      "label": "Global Sign",
                      "description": "The value to select for option 4.",
                      "value": "https://emea.acme.atlas.globalsign.com/directory"
                    }
                  ],
                  "required": true
                },
                "visible": "[if(equals(steps('acmeStep').endpointSection.endpointType, 'known'), true, false)]"
              },
              {
                "name": "customEndpoint",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom ACME endpoint",
                "placeholder": "Custom ACME endpoint",
                "defaultValue": "",
                "toolTip": "Use alphanumeric characters or hyphens with minimum of 2 characters and maximum of 47 characters.",
                "constraints": {
                  "required": true
                },
                "visible": "[if(equals(steps('acmeStep').endpointSection.endpointType, 'custom'), true, false)]"
              }
            ],
            "visible": true
          },
          {
            "name": "credentialSection",
            "type": "Microsoft.Common.Section",
            "label": "Credential",
            "elements": [
              {
                "name": "mailAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "Mail address",
                "placeholder": "Mail address",
                "defaultValue": "",
                "toolTip": "Use alphanumeric characters or hyphens with a maximum of 40 characters.",
                "constraints": {
                  "required": true
                },
                "visible": true
              },
              {
                "name": "credentialType",
                "type": "Microsoft.Common.OptionsGroup",
                "label": "Credential type",
                "toolTip": "",
                "defaultValue": "None",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "External Account Binding (EAB)",
                      "value": "eab"
                    },
                    {
                      "label": "None",
                      "value": "none"
                    }
                  ],
                  "required": true
                },
                "visible": true
              }
            ],
            "visible": true
          },
          {
            "name": "eabSection",
            "type": "Microsoft.Common.Section",
            "label": "External account binding (EAB)",
            "elements": [
              {
                "name": "keyId",
                "type": "Microsoft.Common.TextBox",
                "label": "Key ID",
                "placeholder": "Key ID",
                "defaultValue": "",
                "toolTip": "Use alphanumeric characters or hyphens with minimum of 2 characters and maximum of 47 characters.",
                "constraints": {
                  "required": true
                },
                "visible": true
              },
              {
                "name": "hmacKey",
                "type": "Microsoft.Common.TextBox",
                "label": "HMAC key",
                "placeholder": "HMAC key",
                "defaultValue": "",
                "toolTip": "Use alphanumeric characters or hyphens with minimum of 2 characters and maximum of 47 characters.",
                "constraints": {
                  "required": true
                },
                "visible": true
              },
              {
                "name": "algorithm",
                "type": "Microsoft.Common.DropDown",
                "label": "HMAC algorithm",
                "placeholder": "HMAC algorithm",
                "defaultValue": "HS256",
                "toolTip": "Use alphanumeric characters or hyphens with minimum of 2 characters and maximum of 47 characters.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "HS256",
                      "value": "HS256"
                    },
                    {
                      "label": "HS384",
                      "value": "HS384"
                    },
                    {
                      "label": "HS512",
                      "value": "HS512"
                    }
                  ],
                  "required": true
                },
                "visible": true
              }
            ],
            "visible": "[if(equals(steps('acmeStep').credentialSection.credentialType, 'eab'), true, false)]"
          }
        ]
      },
      {
        "name": "identityStep",
        "label": "Identity",
        "subLabel": {
          "preValidation": "Configure the Identity settings",
          "postValidation": "Completed"
        },
        "elements": [
          {
            "name": "identityType",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Managed identity type",
            "toolTip": "",
            "constraints": {
              "allowedValues": [
                {
                  "label": "System assigned (recommended)",
                  "value": "systemAssigned"
                },
                {
                  "label": "User assigned",
                  "value": "userAssigned"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "userAssignedSelector",
            "type": "Microsoft.Solutions.ResourceSelector",
            "label": "Select user assigned identity",
            "resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "options": {
              "filter": {
                "subscription": "onBasics",
                "location": "all"
              }
            },
            "visible": "[if(equals(steps('identityStep').identityType, 'userAssigned'), true, false)]"
          }
        ]
      },
      {
        "name": "keyvaultStep",
        "label": "Key Vault",
        "subLabel": {
          "preValidation": "Configure the Key Vault settings",
          "postValidation": "Completed"
        },
        "elements": [
          {
            "name": "createNew",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Create new Key Vault",
            "toolTip": "",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Create new (recommended)",
                  "value": "create"
                },
                {
                  "label": "Use existing",
                  "value": "existing"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "keyVaultSelector",
            "type": "Microsoft.Solutions.ResourceSelector",
            "label": "Select key vault",
            "resourceType": "Microsoft.KeyVault/vaults",
            "options": {
              "filter": {
                "subscription": "onBasics",
                "location": "all"
              }
            },
            "visible": "[if(equals(steps('keyvaultStep').createNew, 'existing'), true, false)]"
          }
        ]
      },
      {
        "name": "loggingStep",
        "label": "Logging",
        "subLabel": {
          "preValidation": "Configure the Logging settings",
          "postValidation": "Completed"
        },
        "elements": [
          {
            "name": "createNew",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Create new Log analytics workspace",
            "toolTip": "",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Create new (recommended)",
                  "value": "create"
                },
                {
                  "label": "Use existing",
                  "value": "existing"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "logAnalyticsSelector",
            "type": "Microsoft.Solutions.ResourceSelector",
            "label": "Select log analytics workspace",
            "resourceType": "Microsoft.OperationalInsights/workspaces",
            "options": {
              "filter": {
                "subscription": "onBasics",
                "location": "onBasics"
              }
            },
            "visible": "[if(equals(steps('loggingStep').createNew, 'existing'), true, false)]"
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]"
    }
  }
}
